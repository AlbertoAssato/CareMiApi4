-- Apagando as tabelas
DROP TABLE IF EXISTS t_cm_resultado_exame;
DROP TABLE IF EXISTS t_cm_exame;
DROP TABLE IF EXISTS t_cm_agendamento_exame;
DROP TABLE IF EXISTS t_cm_paciente_plano_saude;
DROP TABLE IF EXISTS t_cm_plano_saude;
DROP TABLE IF EXISTS t_cm_login;
DROP TABLE IF EXISTS t_cm_carteirinha;
DROP TABLE IF EXISTS t_cm_paciente;
DROP TABLE IF EXISTS t_cm_medico;
DROP TABLE IF EXISTS t_cm_usuario;

-- Criação das tabelas
CREATE TABLE t_cm_usuario (
    CdUsuario INT IDENTITY(1,1) PRIMARY KEY,
    NmUsuario VARCHAR(255) NOT NULL,
    DtNascimento DATE NOT NULL,
    NrCpf VARCHAR(15) NOT NULL UNIQUE,
    NrRg VARCHAR(15) NOT NULL UNIQUE,
    DsNacionalidade VARCHAR(50),
    NrTelefone VARCHAR(15),
    DtCadastro DATE NOT NULL,
    DsEstadoCivil VARCHAR(100) CHECK (DsEstadoCivil IN ('SOLTEIRO', 'CASADO', 'DIVORCIADO', 'VIÚVO')),
    DsProfissao VARCHAR(100),
    FgAtivo BIT NOT NULL
);

CREATE TABLE t_cm_medico (
    CdMedico INT IDENTITY(1,1) PRIMARY KEY,
    NmMedico VARCHAR(100) NOT NULL,
    DsEspecializacao VARCHAR(200),
    DsCrm VARCHAR(15) NOT NULL UNIQUE,
    DsEmail VARCHAR(100) NOT NULL UNIQUE,
    NrCelular VARCHAR(15) NOT NULL
);

CREATE TABLE t_cm_paciente (
    CdPaciente INT IDENTITY(1,1) PRIMARY KEY,
    NmPaciente VARCHAR(100) NOT NULL,
    NrPeso DECIMAL(6,2) NOT NULL,
    NrAltura DECIMAL(4,2) NOT NULL,
    NmGrupoSanguineo VARCHAR(6),
    FlSexoBiologico CHAR(1) CHECK (FlSexoBiologico IN ('F', 'M', 'I')) NOT NULL,
    UsuarioCdUsuario INT NOT NULL,
    FOREIGN KEY (UsuarioCdUsuario) REFERENCES t_cm_usuario(CdUsuario)
);

CREATE TABLE t_cm_carteirinha (
    CdCarteirinha INT IDENTITY(1,1) PRIMARY KEY,
    NmPaciente VARCHAR(100) NOT NULL,
    NmPlanoSaude VARCHAR(100) NOT NULL,
    NrCns DECIMAL(15,0) NOT NULL UNIQUE,
    NmEmpresa VARCHAR(100),
    DsCarencia VARCHAR(200),
    DsAcomodacao VARCHAR(200),
    DtNascimento DATE NOT NULL,
    PacienteCdPaciente INT,
    FOREIGN KEY (PacienteCdPaciente) REFERENCES t_cm_paciente(CdPaciente)
);

CREATE TABLE t_cm_agendamento_exame (
    CdAgendamento INT IDENTITY(1,1) PRIMARY KEY,
    NrCPF DECIMAL(11,0) NOT NULL,
    NrRG DECIMAL(15,0) NOT NULL,
    DsNome VARCHAR(100) NOT NULL,
    DsObservacao VARCHAR(250) NOT NULL,
    DtAgendamento DATE NOT NULL,
    DtEnvio DATE NOT NULL,
    MedicoId INT NOT NULL,
    PacienteId INT,
    FOREIGN KEY (MedicoId) REFERENCES t_cm_medico(CdMedico),
    FOREIGN KEY (PacienteId) REFERENCES t_cm_paciente(CdPaciente)
);

CREATE TABLE t_cm_exame (
    CdExame INT IDENTITY(1,1) PRIMARY KEY,
    DtExame DATE NOT NULL,
    DsExame VARCHAR(50) NOT NULL,
    AgendamentoExameId INT,
    FOREIGN KEY (AgendamentoExameId) REFERENCES t_cm_agendamento_exame(CdAgendamento)
);

CREATE TABLE t_cm_login (
    CdLogin INT IDENTITY(1,1) PRIMARY KEY,
    NrCpf VARCHAR(15) NOT NULL,
    DsSenha VARCHAR(100) NOT NULL,
    FgAtivo BIT NOT NULL,
    UsuarioId INT NOT NULL,
    FOREIGN KEY (UsuarioId) REFERENCES t_cm_usuario(CdUsuario)
);

CREATE TABLE t_cm_plano_saude (
    CdPlanoSaude INT IDENTITY(1,1) PRIMARY KEY,
    DsRazaoSocial VARCHAR(100) NOT NULL,
    NmFantasia VARCHAR(100) NOT NULL,
    NrCnpj DECIMAL(14,0) NOT NULL UNIQUE,
    NmContato VARCHAR(100) NOT NULL,
    NrTelefone VARCHAR(15) NOT NULL,
    DtCadastro DATE NOT NULL,
    FgAtivo BIT NOT NULL
);

CREATE TABLE t_cm_paciente_plano_saude (
    CdPlanoPaciente INT IDENTITY(1,1) PRIMARY KEY,
    NrCarteira DECIMAL(15,0) NOT NULL UNIQUE,
    DtInicio DATE NOT NULL,
    DtFim DATE NOT NULL,
    PlanoSaudeId INT NOT NULL,
    PacienteId INT NOT NULL,
    FOREIGN KEY (PlanoSaudeId) REFERENCES t_cm_plano_saude(CdPlanoSaude),
    FOREIGN KEY (PacienteId) REFERENCES t_cm_paciente(CdPaciente)
);

CREATE TABLE t_cm_resultado_exame (
    CdResultado INT IDENTITY(1,1) PRIMARY KEY,
    DsResultado VARCHAR(500) NOT NULL,
    DsObservacoes VARCHAR(100),
    VrResultado DECIMAL(5,2),
    NrGlobulosVermelhos INT,
    NrGlobulosBrancos INT,
    NrPlaquetas INT,
    NrHemoglobinaGlicada INT,
    NrCreatinina INT,
    NrColesterolTotal INT,
    NrColesterolHDL INT,
    NrColesterolLDL INT,
    NrTriglicerides INT,
    NrHormônioTireostimulanteTSH INT,
    TExameCdExame INT NOT NULL,
    FOREIGN KEY (TExameCdExame) REFERENCES t_cm_exame(CdExame)
);

CREATE UNIQUE INDEX IX_T_CM_CARTEIRINHA_CD_PACIENTE ON t_cm_carteirinha (PacienteCdPaciente);
CREATE UNIQUE INDEX IX_T_CM_CARTEIRINHA_CD_CARTEIRINHA ON t_cm_carteirinha (CdCarteirinha);
CREATE UNIQUE INDEX IX_T_CM_EXAME_CD_EXAME ON t_cm_exame (CdExame);
CREATE UNIQUE INDEX IX_T_CM_MEDICO_CD_MEDICO ON t_cm_medico (CdMedico);
CREATE UNIQUE INDEX IX_T_CM_PACIENTE_CD_PACIENTE ON t_cm_paciente (CdPaciente);
CREATE UNIQUE INDEX IX_T_CM_PACIENTE_CD_USUARIO ON t_cm_paciente (UsuarioCdUsuario);
CREATE UNIQUE INDEX IX_T_CM_PACIENTE_PLANO_SAUDE_CD_PLANO_PACIENTE ON t_cm_paciente_plano_saude (CdPlanoPaciente);
CREATE UNIQUE INDEX IX_T_CM_PLANO_SAUDE_CD_PLANO_SAUDE ON t_cm_plano_saude (CdPlanoSaude);
CREATE UNIQUE INDEX IX_T_CM_RESULTADO_EXAME_CD_RESULTADO ON t_cm_resultado_exame (CdResultado);
CREATE UNIQUE INDEX IX_T_CM_RESULTADO_EXAME_CD_EXAME ON t_cm_resultado_exame (TExameCdExame);
CREATE UNIQUE INDEX IX_T_CM_USUARIO_CD_USUARIO ON t_cm_usuario (CdUsuario);
--------------------------------------------------------
-- Constraints for Table T_CM_USUARIO
--------------------------------------------------------

ALTER TABLE T_CM_USUARIO
ALTER COLUMN CD_USUARIO INT NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN FG_ATIVO BIT NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN NR_CPF VARCHAR(11) NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN DT_CADASTRO DATE NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN DT_NASCIMENTO DATE NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN DS_NACIONALIDADE VARCHAR(100) NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN NM_USUARIO VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN NR_RG VARCHAR(20) NOT NULL;

ALTER TABLE T_CM_USUARIO
ALTER COLUMN DS_SENHA VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_USUARIO ADD CONSTRAINT PK_T_CM_USUARIO PRIMARY KEY (CD_USUARIO);
ALTER TABLE T_CM_USUARIO ADD CONSTRAINT CHK_ESTADO_CIVIL CHECK (DsEstadoCivil IN ('SOLTEIRO', 'CASADO', 'DIVORCIADO', 'VIUVO'));

--------------------------------------------------------
-- Constraints for Table T_CM_MEDICO
--------------------------------------------------------

ALTER TABLE T_CM_MEDICO
ALTER COLUMN CD_MEDICO INT NOT NULL;

ALTER TABLE T_CM_MEDICO
ALTER COLUMN NR_CELULAR VARCHAR(15) NOT NULL;

ALTER TABLE T_CM_MEDICO
ALTER COLUMN DS_CRM VARCHAR(20) NOT NULL;

ALTER TABLE T_CM_MEDICO
ALTER COLUMN DS_EMAIL VARCHAR(100) NOT NULL;

ALTER TABLE T_CM_MEDICO
ALTER COLUMN DS_ESPECIALIZACAO VARCHAR(100) NOT NULL;

ALTER TABLE T_CM_MEDICO
ALTER COLUMN NM_MEDICO VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_MEDICO
ALTER COLUMN CD_USUARIO INT NOT NULL;

ALTER TABLE T_CM_MEDICO ADD CONSTRAINT PK_T_CM_MEDICO PRIMARY KEY (CD_MEDICO);

--------------------------------------------------------
-- Constraints for Table T_CM_PACIENTE
--------------------------------------------------------

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN CD_PACIENTE INT NOT NULL;

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN NR_ALTURA DECIMAL(5, 2) NOT NULL;

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN NM_GRUPO_SANGUINEO VARCHAR(3) NOT NULL;

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN NM_PACIENTE VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN NR_PESO DECIMAL(5, 2) NOT NULL;

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN FL_SEXO_BIOLOGICO VARCHAR(20) NOT NULL;

ALTER TABLE T_CM_PACIENTE
ALTER COLUMN CD_USUARIO INT NOT NULL;

ALTER TABLE T_CM_PACIENTE ADD CONSTRAINT PK_T_CM_PACIENTE PRIMARY KEY (CD_PACIENTE);
ALTER TABLE T_CM_PACIENTE ADD CONSTRAINT CHK_SEXO_BIOLOGICO CHECK (FlSexoBiologico IN ('F', 'M', 'I'));
ALTER TABLE T_CM_PACIENTE ADD CONSTRAINT UK_CM_PACIENTE_CD_USUARIO UNIQUE (CD_USUARIO);

--------------------------------------------------------
-- Constraints for Table T_CM_CARTEIRINHA
--------------------------------------------------------

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN CD_CARTEIRINHA INT NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN DS_ACOMODACAO VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN DS_CARENCIA VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN NR_CNS VARCHAR(15) NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN DT_NASCIMENTO DATE NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN NM_EMPRESA VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN NM_PACIENTE VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN NM_PLANO_SAUDE VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA
ALTER COLUMN CD_PACIENTE INT NOT NULL;

ALTER TABLE T_CM_CARTEIRINHA ADD CONSTRAINT PK_T_CM_CARTEIRINHA PRIMARY KEY (CD_CARTEIRINHA);
ALTER TABLE T_CM_CARTEIRINHA ADD CONSTRAINT UK_CM_CARTEIRINHA_CD_PACIENTE UNIQUE (CD_PACIENTE);

--------------------------------------------------------
-- Constraints for Table T_CM_AGENDAMENTO_EXAME
--------------------------------------------------------

ALTER TABLE T_CM_AGENDAMENTO_EXAME
ALTER COLUMN CD_AGENDAMENTO INT NOT NULL;

ALTER TABLE T_CM_AGENDAMENTO_EXAME
ALTER COLUMN DT_AGENDAMENTO DATETIME NOT NULL;

ALTER TABLE T_CM_AGENDAMENTO_EXAME
ALTER COLUMN CD_PACIENTE INT NOT NULL;

ALTER TABLE T_CM_AGENDAMENTO_EXAME
ALTER COLUMN CD_MEDICO INT NOT NULL;

ALTER TABLE T_CM_AGENDAMENTO_EXAME
ALTER COLUMN CD_EXAME INT NOT NULL;

ALTER TABLE T_CM_AGENDAMENTO_EXAME ADD CONSTRAINT PK_T_CM_AGENDAMENTO_EXAME PRIMARY KEY (CD_AGENDAMENTO);

--------------------------------------------------------
-- Constraints for Table T_CM_EXAME
--------------------------------------------------------

ALTER TABLE T_CM_EXAME
ALTER COLUMN CD_EXAME INT NOT NULL;

ALTER TABLE T_CM_EXAME
ALTER COLUMN DT_EXAME DATETIME NOT NULL;

ALTER TABLE T_CM_EXAME
ALTER COLUMN DS_EXAME VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_EXAME
ALTER COLUMN CD_AGENDAMENTO INT NOT NULL;

ALTER TABLE T_CM_EXAME ADD CONSTRAINT PK_T_CM_EXAME PRIMARY KEY (CD_EXAME);

--------------------------------------------------------
-- Constraints for Table T_CM_PLANO_SAUDE
--------------------------------------------------------

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN CD_PLANO_SAUDE INT NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN FG_ATIVO BIT NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN NR_CNPJ VARCHAR(20) NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN NM_CONTATO VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN DT_CADASTRO DATE NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN NM_FANTASIA VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN DS_RAZAO_SOCIAL VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE
ALTER COLUMN NR_TELEFONE VARCHAR(20) NOT NULL;

ALTER TABLE T_CM_PLANO_SAUDE ADD CONSTRAINT PK_T_CM_PLANO_SAUDE PRIMARY KEY (CD_PLANO_SAUDE);

--------------------------------------------------------
-- Constraints for Table T_CM_PACIENTE_PLANO_SAUDE
--------------------------------------------------------

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE
ALTER COLUMN CD_PLANO_PACIENTE INT NOT NULL;

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE
ALTER COLUMN NR_CARTEIRA VARCHAR(50) NOT NULL;

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE
ALTER COLUMN DT_FIM DATE NOT NULL;

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE
ALTER COLUMN DT_INICIO DATE NOT NULL;

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE
ALTER COLUMN CD_PACIENTE INT NOT NULL;

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE
ALTER COLUMN CD_PLANO_SAUDE INT NOT NULL;

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE ADD CONSTRAINT PK_T_CM_PACIENTE_PLANO_SAUDE PRIMARY KEY (CD_PLANO_PACIENTE);

--------------------------------------------------------
-- Constraints for Table T_CM_RESULTADO_EXAME
--------------------------------------------------------

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN CD_RESULTADO INT NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_COLESTEROLHDL DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_COLESTEROLLDL DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_COLESTEROL_TOTAL DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_CREATINA DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN DS_RESULTADO VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_GLOBULOS_BRANCOS INT NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_GLOBULOS_VERMELHOS INT NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_HOMOGLOBINA_GLICADA DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_HORMONIO_TRIO_ESTIMULANTETSH DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN DS_OBSERVACOES VARCHAR(255) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN NR_PLAQUETAS INT NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN VR_RESULTADO DECIMAL(10, 2) NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME
ALTER COLUMN CD_EXAME INT NOT NULL;

ALTER TABLE T_CM_RESULTADO_EXAME ADD CONSTRAINT PK_T_CM_RESULTADO_EXAME PRIMARY KEY (CD_RESULTADO);

--------------------------------------------------------
--  Ref Constraints for Table T_CM_CARTEIRINHA
--------------------------------------------------------

ALTER TABLE T_CM_CARTEIRINHA 
ADD CONSTRAINT FK_T_CM_CARTEIRINHA_PACIENTE 
FOREIGN KEY (CD_PACIENTE) REFERENCES T_CM_PACIENTE (CD_PACIENTE);

--------------------------------------------------------
--  Ref Constraints for Table T_CM_EXAME
--------------------------------------------------------

ALTER TABLE T_CM_EXAME 
ADD CONSTRAINT FK_T_CM_EXAME_AGENDAMENTO 
FOREIGN KEY (CD_AGENDAMENTO) REFERENCES T_CM_AGENDAMENTO_EXAME (CD_AGENDAMENTO);

--------------------------------------------------------
--  Ref Constraints for Table T_CM_PACIENTE
--------------------------------------------------------

ALTER TABLE T_CM_PACIENTE 
ADD CONSTRAINT FK_T_CM_PACIENTE_USUARIO 
FOREIGN KEY (CD_USUARIO) REFERENCES T_CM_USUARIO (CD_USUARIO);

--------------------------------------------------------
--  Ref Constraints for Table T_CM_PACIENTE_PLANO_SAUDE
--------------------------------------------------------

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE 
ADD CONSTRAINT FK_T_CM_PACIENTE_PLANO_SAUDE_PACIENTE 
FOREIGN KEY (CD_PACIENTE) REFERENCES T_CM_PACIENTE (CD_PACIENTE);

ALTER TABLE T_CM_PACIENTE_PLANO_SAUDE 
ADD CONSTRAINT FK_T_CM_PACIENTE_PLANO_SAUDE_PLANO_SAUDE 
FOREIGN KEY (CD_PLANO_SAUDE) REFERENCES T_CM_PLANO_SAUDE (CD_PLANO_SAUDE);

--------------------------------------------------------
--  Ref Constraints for Table T_CM_RESULTADO_EXAME
--------------------------------------------------------

ALTER TABLE T_CM_RESULTADO_EXAME 
ADD CONSTRAINT FK_T_CM_RESULTADO_EXAME_EXAME 
FOREIGN KEY (CD_EXAME) REFERENCES T_CM_EXAME (CD_EXAME);
